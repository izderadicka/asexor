<html>
<head>
  <title>Test Asexor</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <style>
    .hidden {
      display:none;
    }

    .results-section {
    margin-top: 3em;
    }
  </style>
</head>
<body>
  <div class="container">
<h1>ASEXOR = ASynchronous EXecutOR</h1>
<h2>Requirements</h2>
  <p> Recent Browser (ES6 support - FF 45+, Chorme 51+), Linux, Python 3.5 (3.5 only!), python packages autobahn and crossbar (install via pip)</p>
  <p>Assure that crossbar router <br>
    <code>crossbar start</code> <br>
    and dummy_server , <br>
    <code>python dummy_server.py</code> <br>
    are started from test directory.
  </p>
<h2>Test remote tasks</h2>
<div id="task selector" class="form-group">
  <label>Task</label>
  <select id="task-type">
    <option value="date">date</option>
    <option value="sleep">sleep</option>
  </select>
</div>
<div id="params">
<div class="hidden form-group" id="date-params">
  <label>Date format</label>
  <select id="date-format">
    <option value="%d-%m-%Y %H:%M %Z">DD-MM-YYYY HH:MM TZ</option>
    <option value="%d-%b-%y">DD-Mon-YY</option>
    <option value="%x %X">Locale representation</option>
  </select>
  <label>UTC Time?</label>
  <input type="checkbox" id="date-utc">
</div>
<div class="hidden form-group" id="sleep-params">
  <label>Sleep seconds</label>
  <input type="text" value="1" id="sleep-time">
</div>
</div>

<button class="btn btn-primary" id="run-task">Submit Task</button>

<div class="results-section">
  <table class="table">
    <thead>
    <tr><th>Task ID</th><th>Task Type</th><th>Status</th><th>Result</th></tr>
  </thead>
    <tbody id="results">
    </tbody>
  </table>

<div>
</div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>

<script>
$(function() {
  console.log('All loaded');
  const USER='ivan';
  var currentSession = null,
      count=0,
      tasksList= new Array(),
      tasksStatus= new Map();

  let connection = new autobahn.Connection({
    url: 'ws://127.0.0.1:8880/ws',
    realm: 'realm1',
    authmethods: ["ticket"],
    authid: USER,
    onchallenge: (session, method, extra) => { console.log('Authentication challenge', session, method, extra); return 'dummy_token'}
  });

  let task_updated = function (args, kwargs, details) {
    console.log('Task update', args, kwargs, details);
    let task_id=args[0];
    if tasksStatus.has(task_id) {
      let s = tasksStatus.get(task_id);
      s.status = kwargs.status;
      s.result = kwargs.error? kwargs.error : kwargs.result;
      show_results()
    } else {
      console.log(`ERROR - uknown task ${task_id}`);
    }
  }

  let show_params=function() {
    let selected=$('#task-type').val();
    $('#params .form-group').addClass('hidden');
    $(`#${selected}-params`).removeClass('hidden');
  }

  let show_results=function() {
    var task_id,
      root=$('<tbody id="results">');
    for (task_id of tasksList) {
      var status, row;
      status= tasksStatus.get(task_id);
      row=$('<tr>');
      $('<td>').text(task_id).appendTo(row);
      $('<td>').text(status.task).appendTo(row);
      $('<td>').text(status.status).appendTo(row);
      $('<td>').text(status.result).appendTo(row);
      root.append(row);
    }
    $('#results').replaceWith(root)
  }

  connection.onopen = function (session) {
    console.log('Connection opened', session);
    session.subscribe('eu.zderadicka.asexor.task_update', task_updated);
    currentSession=session
  }

  connection.onclose = function (reason, details) {
    console.log('Connection closed', reason, details);
    currentSession=null;
  }

  connection.open();
  show_params();
  $('#task-type').on('change', show_params);
  $('#run-task').on('click', function (evt) {
    if (! currentSession) {
      alert('Not connected!');
      return;
    }
    let selected=$('#task-type').val();
    var args=[], kwargs={};

    switch (selected) {
      case 'date':
        args=['date', $('#date-format').val()];
        kwargs={utc:$('#date-utc').prop('checked')};
        break;
      case 'sleep':
        args=['sleep', parseInt($('#sleep-time').val())]
        break;
    };

    currentSession.call('eu.zderadicka.asexor.run_task', args, kwargs).then(
      function(res) {
        console.log('Task id is '+ res);
        tasksList.unshift(res);
        tasksStatus.set(res, {status:'sent', 'task': selected});
        show_results();
      },
      function(err) {
        console.log('Task submission error', err);
        alert(`Failed to submit task ${selected}: ${err}`);
      }
    )
  })

});
</script>
</body>
</html>
